# Macau

## The problem: MEV
MEV (Miner Extracted Value, Maximum Extractable Value, etc) refers to potential profits that could be generated by block builders in the DeFi ecosystem. i.e. rearranging, inserting, withholding, intercepting transactions in response to transaction requests. For those who are interested, [here](https://arxiv.org/abs/2411.03327) is a comprehensive survey paper.

It's pretty clear that AMMs provide intuitive and fast liquidity at the expense of such opportunity. It is tempting to think that a batch based auction would eliminiate the issue, but I came across a [paper](https://dl.acm.org/doi/10.1145/3736252.3742581) that presented extractable value in batch auction settings.

I have only heard or read about MEV over the last year or so, so it seemed like a good time to learn the basics.

## Assumptions
Here are few assumptions I make for this quick hack.

1. I will assume that Uniswap V2 requests are batch auction requests. In theory, the MEV extractable from a standard AMM should be strictly greater than that of batch auctioning system. CoW swap supports batch auction but it's off-chain, and I wasn't able to gain access to their auctions endpoint. So I am using Uniswap V2 as a knock-off. This assumption is clearly wrong, but doesn't affect my goal of attempting to capture a 'lower bound' of MEV.
2. The exogenous pricing of assets are stable within 5-10 minutes. I build and reference the asset prices after receiving a dump from the mempool. There's a latency due to lookups/waiting, hence a lag in asset price.
3. Since pending requests don't specify gas spent, we fallback to gas limit to capture the upperbound.
4. I clamp the fair price of tokens because some scam/meme coins with no liquidity creates a lot of noise in data.

## Data collection (target DEX)
Here's what I did for data collection.
1. Access quicknode to dump transaction requests in the ethereum mainnet. - `mempool_onchain_snapshot.py`
2. Extract the pending requests and filter transaction requests to Uniswap V2. - `mempool_onchain_load_filter.py`
3. I decode the request and write out the parsed/human-readable info to `decoded_swaps.json`.
4. Exogenous prices built from quoting DEXs get written to `exo.json`.
5. I run the strategy presented by the paper, and check how much potential profit there is for trades related to `WETH`.

## Outcomes
Step 1.
```json
{"jsonrpc": "2.0", "id": 1, "result": {"pending": {"0x0000004eDaFcc12...
```

Step 2/3/4.
```json
[
  {
    "function": "swapExactETHForTokens",
    "amountOutMin": 21638501899,
    "path": [
      {
        "address": "0xC02aaA39b223FE8D0A0e5C4F27eAD9083C756Cc2",
        "symbol": "WETH",
    ...
```
```json
{
  "0x7714f320adca62b149df2579361afec729c5fe6a": {
    "symbol": "0x7714f320adca62b149df2579361afec729c5fe6a",
    "price_usd": 0.008885270340371045,
    "decimals": 18
  },
  "0xf79f9020560963422ecc9c0c04d3a21190bbf045": {
    "symbol": "0xf79f9020560963422ecc9c0c04d3a21190bbf045",
    "price_usd": 4.163221899268408e-12,
    "decimals": 9
  },
  ...
```

Step 5.

```
=== MEV Summary ===
Pairs executed / total: 2 / 40
Executed tx / candidate tx: 2 / 44
Total profit (USD): 2,666.79
Included gas (USD): 0.01
Net profit after included gas (USD): 2,666.78
Missed gas (USD): 499.76
Realized-to-missed ratio: 5.34
```

So it looks like there's decent enough MEV in a batch auctions setting, though I find the general efficacy of batch auctioning over AMM questionable.

## Vibe acknowledgement

I acknowledge the work of `openai/gpt-5` in assisting me code `token_pricing.py` and doing the pretty prints for `mempool_onchain_load_filter_decode.py`, and teaching me information regarding components of blockchain and web3.
